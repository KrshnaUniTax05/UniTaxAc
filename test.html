<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form with Dynamic Table</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body onload="starting()">
    <div class="container mt-4">
        <!-- Nav tabs -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab" aria-controls="home" aria-selected="true">Home</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" aria-controls="profile" aria-selected="false">Profile</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="contact-tab" data-bs-toggle="tab" data-bs-target="#contact" type="button" role="tab" aria-controls="contact" aria-selected="false">Contact</button>
            </li>
        </ul>

        <!-- Tab panes -->
        <div class="tab-content mt-3" id="myTabContent">
            <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                <p>This is the home tab content.</p>
                <section>
                    <!-- Form 1 -->
                    <form id="form1">
                        <table class="table table align-middle" >
                            <thead>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Action</th>
                            </thead>
                            <tbody>
                                <tr class="align-middle">
                                    <td>
                            <input type="hidden" class="form-control" id="user" name="user" placeholder="Enter your name">
                            <div class="">
                                <!-- <label for="inputText" class="form-label">Field Name</label> -->
                                <input type="text" class="form-control" id="name" name="name" placeholder="Enter your name" required>
                            </div>
                            </td>
                            <td>
                            <div class="">
                                <!-- <label for="inputEmail" class="form-label">Email</label> -->
                                <select name="fieldtype" id="fieldtype" class="form-select">
                                    <option value="Bown">Bown</option>
                                    <option value="Tab">Tab</option>
                                    <option value="Section">Section</option>
                                    <option value="Field">Field</option>
                                </select>

                            </div>
                            </td>
                            <td >
                            <button type="submit" class="btn btn-primary">Submit Form 1</button>
                            </td>
                            </tr>
                            </tbody>
                        </table>
                    </form>
                </section>

                <br>
                <section>
                    <!-- Form 2 -->
                   
                </section>

                <br>
                <section>
                    <div class="card" style="overflow: scroll; height: 400px;">
                        <div class="card-header">
                            <h5 class="card-title">Fixed Header Table</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-bordered" id="sheet2Table">
                                <thead>
                                    <tr>
                                        <th>Field Name</th>
                                        <th>Field type</th>
                                        <th>Field Code</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data from Sheet 1 will be populated here -->
                                     <!-- Bootstrap Loader -->
                                <div id="loader" class="spinner-border text-primary" role="status" style="display: none;">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
        
                                    
                                </tbody>
                            </table>
                        </div>
                    </div>

                    
                </section>
            </div>

            <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                <p>This is the profile tab content.</p>

                <form id="form2">
                    <table class="table table-bordered" id="newTable">
                        <thead>
                            <tr>
                                <th scope="col">Field Name</th>
                                <th scope="col">Bown</th>
                                <th scope="col">Tab</th>
                                <th scope="col">Section</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Rows will be inserted here dynamically -->
                             <tr>
                                <td>
                                    <input type="hidden" class="form-control" id="user" name="user" placeholder="Enter something" required>
                                    <div class="mb-3">
                                        <input type="text" class="form-control" id="tblfeild" name="tblfeild" placeholder="Enter something" required>
                                    </div>
                                 </td>
                                <td>
                                    <select class="form-select" id="dynamicDropdown" name="dynamicDropdown">
                                        <option value="" disabled selected>Select an option</option>
                                        <!-- Options will be populated here -->
                                    </select>
                                 </td>
                                <td>
                                    <select class="form-select" id="tabdynamicDropdown" name="tabdynamicDropdown">
                                        <option value="" disabled selected>Select an option</option>
                                        <!-- Options will be populated here -->
                                    </select>
                                 </td>
                                <td>
                                    <select class="form-select" id="sectiondynamicDropdown" name="sectiondynamicDropdown">
                                        <option value="" disabled selected>Select an option</option>
                                        <!-- Options will be populated here -->
                                    </select>
                                 </td>
                             </tr>
                        </tbody>
                    </table>
                    <button type="submit" class="btn btn-primary">Submit Form 1</button>
                </form>
                
                <h1>Sheet 2 Data</h1>
                    <table class="table table-bordered" id="sheet1Table">
                        <thead>
                            <tr>
                                <th>Field Name</th>
                                <th>Bown Name</th>
                                <th>Tab Name</th>
                                <th>Section Name</th>
                                <th>Transaction ID</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data from Sheet 2 will be populated here -->
                             <!-- Bootstrap Loader -->
                                <div id="loader" class="spinner-border text-primary" role="status" style="display: none;">
                                    <span class="visually-hidden">Loading...</span>
                                </div>

                        </tbody>
                    </table>

            </div>

            <div class="tab-pane fade" id="contact" role="tabpanel" aria-labelledby="contact-tab">
                <p>This is the contact tab content.</p>
                <div class="container mt-5">
                    <h2>Delete Entry</h2>
                    <form id="deleteForm" onsubmit="handleDelete(event)">
                        <div class="form-group">
                            <label for="transactionCode">Transaction Code:</label>
                            <input type="text" class="form-control" id="transactionCode" name="transactionCode" required>
                        </div>
                        <button type="submit" class="btn btn-danger">Delete Entry</button>
                    </form>
                </div>
                
                <!-- Bootstrap Modal -->
                <div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog" aria-labelledby="confirmationLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="confirmationLabel">Confirm Deletion</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <p>Related entries found:</p>
                                <table class="table" id="relatedEntriesTable">
                                    <thead>
                                        <tr>
                                            <th>Field Name</th>
                                            <th>Bown</th>
                                            <th>Tab</th>
                                            <th>Section</th>
                                            <th>Transaction Code</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Related entries will be populated here -->
                                    </tbody>
                                </table>
                                <p>Are you sure you want to delete this entry?</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-danger" id="confirmDeleteButton">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
                <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
                <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
                
                                <!-- Delete Row Form -->
                <form id="deleteForm">
                    <div class="mb-3">
                        <label for="transactionCode" class="form-label">Transaction Code</label>
                        <input type="text" class="form-control" id="transactionCode" name="transactionCode" placeholder="Enter Transaction Code" required>
                    </div>
                    <button type="submit" class="btn btn-danger">Delete Row</button>
                </form>

                <!-- Confirmation Modal -->
                <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="confirmModalLabel">Confirm Deletion</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                Are you sure you want to delete this row?
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Error Alert -->
                <div class="alert alert-danger d-none" id="errorAlert" role="alert">
                    Wrong transaction code! Please try again.
                </div>

            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function starting(){
            // Set value for all elements with id 'user' (Not recommended)
            const users = document.querySelectorAll('#user'); // Select all elements with id 'user'
            users.forEach(user => {
            user.value = "123456789"; // Set the value for all elements with id 'user'
            });

        }


        const database = "https://script.google.com/macros/s/AKfycbx_wonao0hrKi1mbAEHTfNcB3DJEAO-IvrdxT_Gc60Zr5XadafrmzyPfdUjeJkdQKz7/exec";
        function fetchDataAndPopulate() {
    const userId = "123456789"; // Set the user ID

    fetch(database)
        .then(response => response.json())
        .then(data => {
            // Populate Sheet 1 Data
            const sheet1Data = data.sheet1Data;
            const sheet1Table = document.getElementById("sheet1Table").getElementsByTagName("tbody")[0];
            sheet1Data.forEach((row, index) => {
                if (index > 0) { // Skip header row
                    const newRow = sheet1Table.insertRow();
                    row.slice(1).forEach(cell => {
                        const newCell = newRow.insertCell();
                        newCell.textContent = cell;
                    });
                }
            });

            // Populate Sheet 2 Data and Filter for Dropdowns
            const sheet2Data = data.sheet2Data;
            const sheet2Table = document.getElementById("sheet2Table").getElementsByTagName("tbody")[0];
            const sectionDropdown = document.getElementById("sectiondynamicDropdown");
            const tabDropdown = document.getElementById("tabdynamicDropdown");
            const dynamicDropdown = document.getElementById("dynamicDropdown");

            // Clear existing options in dropdowns
            clearDropdowns(sectionDropdown, tabDropdown, dynamicDropdown);

            sheet2Data.forEach((row, index) => {
                if (index > 0) { // Skip header row
                    const newRow = sheet2Table.insertRow();
                    row.slice(1).forEach(cell => {
                        const newCell = newRow.insertCell();
                        newCell.textContent = cell;
                    });

                    // Extract relevant data
                    if (row.length >= 3) {
                        const user = row[0];
                        console.log(user) // User ID from the first column
                        const fieldName = row[1]; // Field Name from the second column
                        console.log(fieldName)
                        const type = row[2].trim(); // Type from the third column
                        const TransactionData = row[3]; // Type from the third column

                        // Check if the user matches
                        if (user == userId) {
                            const optionSnippet = `<option value="${TransactionData}">${fieldName}</option>`; // Create option snippet
                            console.log('usermatch')
                            // Populate dropdowns based on the type
                            if (type === "Section") {
                                sectionDropdown.innerHTML += optionSnippet; // Append option snippet
                            } else if (type === "Tab") {
                                tabDropdown.innerHTML += optionSnippet; // Append option snippet
                            } else if (type === "Bown"){
                                dynamicDropdown.innerHTML += optionSnippet; // Append option snippet
                            } else {
                                console.log("Unidentified Entry: "+fieldName )
                            }
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error("Error fetching data:", error);
        });
}

// Function to clear existing dropdown options
function clearDropdowns(...dropdowns) {
    dropdowns.forEach(dropdown => {
        dropdown.innerHTML = ""; // Clear existing options
    });
}

// Call the function to fetch data and populate tables and dropdowns
fetchDataAndPopulate();


        // Function to submit form data
        function submitForm(formId, formData) {
            showLoaderAndClearTables();
            fetch(database, {
                method: "POST",
                body: formData,
                mode: "no-cors"
            })
            .then(response => console.log("Form submitted successfully"))
            .catch(error => console.error("Error submitting form:", error));
            console.log(formData)
            fetchDataAndPopulate();
            hideLoader();
        }

        // Form 1 Submission
        document.getElementById("form1").addEventListener("submit", function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            formData.append("formId", "form1");
            submitForm("form1", formData);
            // fetchDataAndPopulate();
        });

        // Form 2 Submission
        document.getElementById("form2").addEventListener("submit", function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            formData.append("formId", "form2");
            submitForm("form2", formData);
            fetchDataAndPopulate();
        });

        function populateDropdownsFromTable() {
    const userId = "123456789"; // Set the user ID
    const sectionDropdown = document.getElementById("sectiondynamicDropdown");
    const tabDropdown = document.getElementById("tabdynamicDropdown");
    const dynamicDropdown = document.getElementById("dynamicDropdown");

    // Clear existing options
    clearDropdowns(sectionDropdown, tabDropdown, dynamicDropdown);

    // Get the table data
    const sheet2Table = document.getElementById("sheet2Table");
    const rows = sheet2Table.getElementsByTagName("tbody")[0].getElementsByTagName("tr");

    // Iterate over rows and populate dropdowns
    Array.from(rows).forEach(row => {
        const cells = row.getElementsByTagName("td");

        if (cells.length >= 3) {
            const user = cells[0].textContent.trim(); // User ID from the first column
            const fieldName = cells[1].textContent.trim(); // Field Name from the second column
            const type = cells[2].textContent.trim(); // Type from the third column
            const TransCode = cells[3].textContent.trim(); // Type from the third column
            console.log(TransCode)

            // Check if the user matches
            if (user === "123456789") {
                const optionSnippet = `<option value="${TransCode}">Field ${fieldName}</option>`; // Create option snippet

                // Populate dropdowns based on the type
                if (type === "Section") {
                    sectionDropdown.innerHTML += optionSnippet; // Append option snippet
                } else if (type === "Tab") {
                    tabDropdown.innerHTML += optionSnippet; // Append option snippet
                } else {
                    dynamicDropdown.innerHTML += optionSnippet; // Append option snippet
                }
            }
        }
    });
}

// Function to clear existing dropdown options
function clearDropdowns(...dropdowns) {
    dropdowns.forEach(dropdown => {
        dropdown.innerHTML = ""; // Clear existing options
    });
}

// Call the function to populate dropdowns from the table
populateDropdownsFromTable();

function showLoaderAndClearTables() {
    // Show loader
    document.getElementById('loader').style.display = 'block';

    // Clear Sheet 1 Table
    const sheet1Table = document.getElementById("sheet1Table").getElementsByTagName("tbody")[0];
    sheet1Table.innerHTML = ""; // Clear existing rows

    // Clear Sheet 2 Table
    const sheet2Table = document.getElementById("sheet2Table").getElementsByTagName("tbody")[0];
    sheet2Table.innerHTML = ""; // Clear existing rows
}

// Function to hide loader
function hideLoader() {
    document.getElementById('loader').style.display = 'none'; // Hide loader
}
        

function handleDelete(event) {
    event.preventDefault(); // Prevent form submission
    const transactionCode = document.getElementById('transactionCode').value;

    // Fetch request to check if code exists
    fetch(database, {
        method: 'POST',
        action: "delete",
        mode: "no-cors",
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ action: "delete", transactionCode: transactionCode })
    })
    .then(response => {
        // Check if response is okay (status 200)
        if (!response.ok) {
            throw new Error('Network response was not ok: ' + response.statusText);
        }
        return response.text(); // Assuming the response is plain text
    })
    .then(data => {
        try {
            const result = JSON.parse(data);
            if (Array.isArray(result)) {
                populateModal(result); // Populate modal with related entries
                $('#confirmationModal').modal('show'); // Show modal
            } else {
                alert(result); // Alert for error messages
            }
        } catch (error) {
            alert("Error processing the response: " + error.message); // Show error details
        }
    })
    .catch(error => {
        console.error("Fetch error:", error);
        alert("Error fetching data: " + error.message); // Show error details
    });
}


    function populateModal(entries) {
        const tbody = document.getElementById('relatedEntriesTable').getElementsByTagName('tbody')[0];
        tbody.innerHTML = ""; // Clear previous entries
        entries.forEach(entry => {
            const newRow = tbody.insertRow();
            entry.forEach(cell => {
                const newCell = newRow.insertCell();
                newCell.textContent = cell;
            });
        });

        // Attach event to confirm delete button
        document.getElementById('confirmDeleteButton').onclick = function() {
            // Call the delete function again with the code and handle deletion
            fetch(database, {
                method: 'POST',
                mode:"no-cors",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ action: "delete", transactionCode: entries[0][4] }) // Assuming transaction code is in the 5th column
            })
            .then(response => response.text())
            .then(result => {
                alert(result); // Alert result of deletion
                $('#confirmationModal').modal('hide'); // Close modal
            });
        };
    }
    </script>

</body>

</html>
